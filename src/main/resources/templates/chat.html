<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Gunpo Community - Real-time Chat</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
</head>
<body>
<div class="d-flex" id="wrapper">
    <!-- Sidebar-->
    <div class="border-end bg-white" id="sidebar-wrapper">
        <div class="sidebar-heading border-bottom bg-light">Gunpo Community</div>
        <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/inquiry-list">ë¬¸ì˜í•˜ê¸°</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/chat">ì‹¤ì‹œê°„ ì±„íŒ…</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/chat/rooms">1ëŒ€1 ì±„íŒ…ë°© ëª©ë¡</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/GyeonggiCurrencyStore">ê²½ê¸°
                ì§€ì—­í™”í ê°€ë§¹ì  ì°¾ê¸°</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/board/list">ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/smoking-area">í¡ì—° êµ¬ì—­</a>
            <a class="list-group-item list-group-item-action list-group-item-light p-3" href="/news">ë‰´ìŠ¤</a>
        </div>
    </div>
    <!-- Page content wrapper-->
    <div id="page-content-wrapper">
        <!-- Top navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <span class="icon">ğŸ </span>
                    <span class="text">í™ˆìœ¼ë¡œ</span>
                </a>
            </div>
        </nav>
        <!-- Page content-->
        <div class="container-fluid">
            <h1 class="my-5 text-center display-4">ì‹¤ì‹œê°„ ì±„íŒ…</h1>

            <p class="text-center text-muted mb-4" style="font-size: 1.1rem;">
                ë¡œê·¸ì¸ ì—†ì´ë„ êµ°í¬ ì‹œë¯¼ ì—¬ëŸ¬ë¶„ì´ ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤.
            </p>

            <!-- Chat box area -->
            <div id="chat-box" class="border rounded shadow-sm p-4 mb-4 bg-white" style="height: 500px; overflow-y: auto; font-size: 1.2rem;">
                <!-- Messages will appear here -->
            </div>

            <!-- Chat input area -->
            <div class="input-group input-group-lg mb-3">
                <input type="text" class="form-control" id="message" placeholder="Type your message here..." aria-label="Message" aria-describedby="send-button">
                <button class="btn btn-primary px-4" id="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<footer class="bg-dark text-white text-center py-4">
    <div class="container">
        <p>&copy; 2024 Gunpo Community Platform. All rights reserved.</p>
        <p>Contact us: <a href="mailto:support@gunpocommunity.kr" class="text-white">support@gunpocommunity.kr</a></p>
        <p>
            <a href="#!" class="text-white">Privacy Policy</a> |
            <a href="#!" class="text-white">Terms of Service</a> |
            <a href="#!" class="text-white">Contact Us</a>
        </p>
    </div>
</footer>

<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>
<!-- WebSocket and REST for real-time chat -->
<script>
    var ws = new WebSocket("ws://localhost:8080/ws/chat");

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ Redisì—ì„œ ì €ì¥ëœ ì±„íŒ… ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function() {
        fetch('/api/chat/messages')
            .then(response => response.json())
            .then(messages => {
                var chatBox = document.getElementById('chat-box');
                messages.forEach(message => {
                    var messageElement = document.createElement('p');
                    messageElement.textContent = message;
                    chatBox.appendChild(messageElement);
                });
            });
    };

    // WebSocketìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ ë°›ê¸°
    ws.onmessage = function(event) {
        var chatBox = document.getElementById('chat-box');
        var message = document.createElement('p');
        message.textContent = event.data;
        chatBox.appendChild(message);
    };

    let isSending = false; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€ í”Œë˜ê·¸

    function sendMessage() {
        var messageInput = document.getElementById('message');
        var messageContent = messageInput.value.trim(); // ê³µë°± ì œê±°

        if (!messageContent || isSending) return; // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì „ì†¡ ì¤‘ì´ë©´ ì¢…ë£Œ

        isSending = true;

        // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        ws.send(messageContent);

        // Redisì— ë©”ì‹œì§€ ì €ì¥
        fetch('/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageContent),
        }).finally(() => {
            isSending = false; // ì „ì†¡ ì™„ë£Œ í›„ í”Œë˜ê·¸ ì´ˆê¸°í™”
            messageInput.value = ''; // ë©”ì‹œì§€ ì „ì†¡ í›„ ì…ë ¥ì°½ ë¹„ìš°ê¸°
        });
    }

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('message').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            sendMessage();
            event.preventDefault(); // Enter í‚¤ë¡œ ê°œí–‰ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
        }
    });

    // ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('send-button').addEventListener('click', sendMessage);
</script>
</body>
</html>
